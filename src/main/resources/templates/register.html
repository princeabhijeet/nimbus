<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8" />
    <title>Register - Nimbus</title>
    <link href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/register.css}" rel="stylesheet" />
</head>
<body>
<main class="rg-hero" th:attr="data-roles-url=@{/api/v1/roles}, data-users-url=@{/api/v1/users}">
    <div class="rg-container">
        <div class="rg-left">
            <h1>Nimbus</h1>
            <p class="tag">Create your account to collaborate securely.</p>
            <ul class="rg-features">
                <li>Role-based access</li>
                <li>Secure GitHub login</li>
                <li>Modern Thymeleaf UI</li>
            </ul>
        </div>
        <div class="rg-card">
            <a class="btn btn-back" th:href="@{/api/v1/mvc/home}">&larr; Back</a>
            <h2>Create an account</h2>
            <form id="registerForm">
                <div class="row">
                    <div class="col">
                        <label for="firstName">First name</label>
                        <input id="firstName" name="firstName" required />
                    </div>
                    <div class="col">
                        <label for="lastName">Last name</label>
                        <input id="lastName" name="lastName" />
                    </div>
                </div>

                <label for="username">Username</label>
                <input id="username" name="username" required />

                <label for="email">Email</label>
                <input id="email" name="email" type="email" required />

                <label for="roles">Role</label>
                <select id="roles" name="role">
                    <option value="">Loading roles...</option>
                </select>

                <div class="actions">
                    <button class="btn btn-primary" type="submit">Register</button>
                </div>
            </form>
            <div id="message" class="message" aria-live="polite"></div>
        </div>
    </div>
</main>

<script>
    (function(){
        const root = document.querySelector('main.rg-hero');
        if (!root) return;
        const URL_ROLES = root.getAttribute('data-roles-url');
        const URL_USERS = root.getAttribute('data-users-url');
        const sel = document.getElementById('roles');
        const msg = document.getElementById('message');

        async function loadRoles(){
            try{
                const resp = await fetch(URL_ROLES, { credentials: 'same-origin' });
                if (!resp.ok) throw new Error('Unable to load roles: ' + resp.status);
                const roles = await resp.json();
                sel.innerHTML = '';
                roles.filter(r => r.name !== 'ROLE_ADMIN' && r.name !== 'ROLE-ADMIN')
                     .forEach(r => {
                         const opt = document.createElement('option');
                         opt.value = r.id;
                         opt.text = r.name;
                         sel.add(opt);
                     });
            } catch (e) {
                console.error(e);
                sel.innerHTML = '<option value="">Unable to load roles</option>';
            }
        }

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.innerText = '';
            const body = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                userRoles: [{ role: { id: parseInt(document.getElementById('roles').value) } }]
            };
            try{
                const resp = await fetch(URL_USERS, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
                });
                if (resp.status === 201) {
                    msg.style.color = 'green';
                    msg.innerText = 'Registration successful. You can now login with GitHub.';
                } else {
                    const text = await resp.text().catch(()=>null);
                    msg.style.color = 'crimson';
                    msg.innerText = 'Registration failed: ' + (text || resp.status);
                }
            }catch(err){
                console.error(err);
                msg.style.color = 'crimson';
                msg.innerText = 'Registration error. Try again.';
            }
        });

        loadRoles();
    })();
</script>
</body>
</html>

