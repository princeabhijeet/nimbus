<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nimbus | Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/home.css}">
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-left">
        <!-- big wordmark -->
        <svg class="logo-large" role="img" aria-label="nimbus" viewBox="0 0 600 96" xmlns="http://www.w3.org/2000/svg" focusable="false">
          <defs>
            <linearGradient id="lg1" x1="0" x2="1"><stop offset="0" stop-color="#7dd3fc"/><stop offset="1" stop-color="#60a5fa"/></linearGradient>
          </defs>
          <text x="0" y="72" font-family="Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial" font-size="56" font-weight="800" fill="url(#lg1)">nimbus</text>
        </svg>
      </div>
      <div class="topbar-actions">
        <!-- Settings (gear) near logout for quick access -->
        <button id="settingsBtn" class="settings-btn" aria-label="Settings" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" fill="#fff" opacity=".9"/><path d="M19.4 13.4c.04-.3.06-.6.06-.9s-.02-.6-.06-.9l2.1-1.65a.5.5 0 0 0 .12-.63l-2-3.46a.5.5 0 0 0-.6-.22l-2.49 1a7.08 7.08 0 0 0-1.56-.9L14.5 2.5a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 0-.5.5l-.38 2.07c-.54.2-1.05.47-1.56.9l-2.49-1a.5.5 0 0 0-.6.22l-2 3.46a.5.5 0 0 0 .12.63L4.6 11.6c-.04.3-.06.6-.06.9s.02.6.06.9L2.5 15.15a.5.5 0 0 0-.12.63l2 3.46c.14.24.44.34.68.24l2.49-1c.5.43 1.02.8 1.56.98L9.5 21.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5l.38-2.07c.54-.2 1.06-.47 1.56-.9l2.49 1c.24.1.54 0 .68-.24l2-3.46a.5.5 0 0 0-.12-.63L19.4 13.4z" fill="#fff" opacity="0.85"/></svg>
        </button>

        <!-- Icon-only logout button (accessible) -->
        <button class="btn-logout" onclick="logout()" aria-label="Logout" title="Logout">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M16 13v-2H7V8l-5 4 5 4v-3h9z" fill="#fff"/><path d="M20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="#fff" opacity="0.9"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar" aria-label="Primary">
      <nav>
        <ul>
          <li class="active">Dashboard</li>
          <li>Projects</li>
          <li>Teams</li>
          <li>Settings</li>
        </ul>
      </nav>
    </aside>

    <section class="main-panel">
      <div class="panel card">
        <div class="card-body">
          <!-- profile summary -->
          <section class="user-badge" id="profile">
            <h3 id="dashboard-title">Welcome back!</h3>
            <p>Name: <strong id="fullName">-</strong></p>
            <p>Email: <span id="email" class="muted">-</span></p>
            <p>Current company: <span id="company" class="muted">-</span></p>
            <p>Total experience: <span id="experience" class="muted">-</span></p>
            <p>Address: <span id="address" class="muted">-</span></p>
            <div style="margin-top:10px">
              <button id="editProfile" class="tile-action">Edit profile</button>
            </div>
          </section>

          <!-- files / resume area -->
          <section class="file-card">
            <h4>Files</h4>
            <p class="muted">Upload your resume or any files you may need later.</p>

            <div class="upload-area">
              <input id="fileInput" type="file" />
              <button id="uploadBtn" class="tile-action">Upload</button>
            </div>

            <div class="file-list" id="fileList">
              <!-- files will be inserted here -->
              <div class="muted">No files uploaded yet.</div>
            </div>

            <div style="margin-top:12px">
              <button id="downloadResumeBtn" class="tile-action primary">Download resume</button>
            </div>
          </section>

          <!-- quick links -->
          <section class="dashboard-grid" aria-label="quick links">
            <div class="tile">Projects</div>
            <div class="tile">Teams</div>
            <div class="tile">Settings</div>
          </section>
        </div>
      </div>

      <p class="note">we respect your privacy — your account choice is private.</p>
    </section>
  </main>

<!-- Settings modal (light-weight) -->
<div id="settingsModal" class="settings-modal" aria-hidden="true">
  <div class="settings-content">
    <header class="settings-header">
      <h3>Settings & Profile</h3>
      <button id="closeSettings" class="close" onclick="closeSettingsModal()">✕</button>
    </header>
    <form id="settingsForm">
      <div class="form-row"><input name="firstName" id="firstName" placeholder="First name" aria-label="First name" /></div>
      <div class="form-row"><input name="lastName" id="lastName" placeholder="Last name" aria-label="Last name" /></div>
      <div class="form-row"><input name="email" id="emailInput" type="email" placeholder="Email" aria-label="Email address" /></div>
      <div class="form-row"><input name="company" id="companyInput" placeholder="Company" aria-label="Company" /></div>
      <div class="form-row"><input name="experience" id="experienceInput" placeholder="Total experience (e.g. 3 years)" aria-label="Total experience" /></div>
      <div class="form-row"><input name="address" id="addressInput" placeholder="Current address" aria-label="Current address" /></div>
      <div style="margin-top:12px">
        <button type="submit" class="tile-action primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  const API_PROFILE = '/nimbus/api/v1/profile'; // Assumption: GET returns {username,email,firstName,lastName,...}
  const API_FILES = '/nimbus/api/v1/files'; // Assumption: GET -> list, POST -> upload, GET /:id/download -> download

  const toastEl = document.getElementById('toast');
  let _toastTimer = null;
  function showToast(msg){
    if (!toastEl) { alert(msg); return; }
    // Reset any existing timer so messages don't overlap
    if (_toastTimer) { clearTimeout(_toastTimer); _toastTimer = null; }
    // Set message and trigger show animation
    toastEl.textContent = msg;
    toastEl.classList.remove('show');
    // force reflow so repeated calls restart the animation
    void toastEl.offsetWidth;
    toastEl.classList.add('show');

    // Hide after 3s and clear content shortly after hide completes
    _toastTimer = setTimeout(() => {
      toastEl.classList.remove('show');
      setTimeout(() => { if (!toastEl.classList.contains('show')) toastEl.textContent = ''; }, 220);
      _toastTimer = null;
    }, 3000);
  }

  async function fetchProfile(){
    try{
      const res = await fetch(API_PROFILE);
      if(!res.ok) throw new Error('profile fetch failed');
      const data = await res.json();
      const full = [data.firstName, data.lastName].filter(Boolean).join(' ') || data.username || '-';
      document.getElementById('fullName').textContent = full;
      document.getElementById('email').textContent = data.email || '-';
      // placeholder fields
      document.getElementById('company').textContent = data.company || '-';
      document.getElementById('experience').textContent = data.experience || '-';
      document.getElementById('address').textContent = data.address || '-';
      // populate settings form
      document.getElementById('firstName').value = data.firstName||'';
      document.getElementById('lastName').value = data.lastName||'';
      document.getElementById('emailInput').value = data.email||'';
      document.getElementById('companyInput').value = data.company||'';
      document.getElementById('experienceInput').value = data.experience||'';
      document.getElementById('addressInput').value = data.address||'';
    }catch(err){
      console.warn(err); showToast('Unable to fetch profile');
    }
  }

  async function fetchFiles(){
    const listEl = document.getElementById('fileList');
    listEl.innerHTML = '';
    try{
      const res = await fetch(API_FILES);
      if(!res.ok) throw new Error('files fetch failed');
      const files = await res.json();
      if(!files.length){ listEl.innerHTML = '<div class="muted">No files uploaded yet.</div>'; return; }
      files.forEach(f=>{
        const item = document.createElement('div'); item.className='file-item';
        item.innerHTML = `<div class="file-name">${f.name}</div><div class="file-actions"><button class="tile-action" data-id="${f.id}">Download</button></div>`;
        listEl.appendChild(item);
      });
    }catch(err){ console.warn(err); listEl.innerHTML='<div class="muted">Unable to load files</div>'; }
  }

  async function uploadFile(){
    const input = document.getElementById('fileInput');
    if(!input.files.length) { showToast('Please pick a file'); return; }
    const file = input.files[0];
    const fd = new FormData(); fd.append('file', file);
    try{
      const res = await fetch(API_FILES, { method:'POST', body:fd });
      if(!res.ok) throw new Error('upload failed');
      showToast('Uploaded'); input.value=''; fetchFiles();
    }catch(err){ console.warn(err); showToast('Upload failed'); }
  }

  async function downloadFile(id){
    try{
      // direct navigation to REST endpoint
      window.location = `${API_FILES}/${id}/download`;
    }catch(err){ console.warn(err); showToast('Download failed'); }
  }

  async function downloadResume(){
    try{
      // try to find a resume file (backend could return special flag) - we request list and pick first with 'resume' in name
      const res = await fetch(API_FILES); if(!res.ok) throw new Error(); const files=await res.json();
      const resume = files.find(f=>/resume/i.test(f.name)) || files[0];
      if(!resume) { showToast('No files available'); return; }
      window.location = `${API_FILES}/${resume.id}/download`;
    }catch(err){ console.warn(err); showToast('No resume available'); }
  }

  // Settings modal
  const settingsBtn = document.getElementById('settingsBtn');
  const modal = document.getElementById('settingsModal');
  const closeSettings = document.getElementById('closeSettings');
  const settingsContent = document.querySelector('.settings-content');
  const settingsHeader = document.querySelector('.settings-header');
  // Reset modal position/styles so CSS centering works
  function resetSettingsPosition(){
    if (!settingsContent) return;
    settingsContent.style.position = '';
    settingsContent.style.left = '';
    settingsContent.style.top = '';
    settingsContent.style.margin = '';
  }

  // Open/close helpers that manage aria, position reset and focus
  function openSettingsModal(){
    if (!modal) return;
    resetSettingsPosition();
    modal.setAttribute('aria-hidden','false');
    // ensure CSS centering applies (clear inline display)
    modal.style.display = '';
    // focus the content for keyboard users
    if (settingsContent) { settingsContent.setAttribute('tabindex','-1'); settingsContent.focus(); }
  }

  function closeSettingsModal(){
    if (!modal) return;
    // hide overlay and clear inline-position so it recenters next time
    modal.setAttribute('aria-hidden','true');
    modal.style.display = 'none';
    resetSettingsPosition();
  }

  // Delegate opening/closing
  settingsBtn?.addEventListener('click', openSettingsModal);

  // Delegate clicks: close when clicking the close button or the overlay backdrop
  document.addEventListener('click', (e)=>{
    if (!modal) return;
    // close button
    if (e.target.closest && e.target.closest('#closeSettings')){ closeSettingsModal(); return; }
    // clicking on overlay outside content
    if (e.target === modal){ closeSettingsModal(); return; }
  });

  // Explicit close button handler (robust fallback)
  closeSettings?.addEventListener('click', (ev) => { ev.preventDefault(); closeSettingsModal(); settingsBtn?.focus(); });
  // also handle pointerdown so drag/capture doesn't intercept the click
  closeSettings?.addEventListener('pointerdown', (ev) => { ev.preventDefault(); ev.stopPropagation(); closeSettingsModal(); settingsBtn?.focus(); });

   // Close on Escape key when modal is open
   document.addEventListener('keydown', (e)=>{
     if (!modal) return;
     if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false'){
       closeSettingsModal();
     }
   });

  // Draggable support using Pointer Events on settings header
  if (settingsHeader && settingsContent){
    let dragging = false;
    let startX = 0, startY = 0, origLeft = 0, origTop = 0;

    settingsHeader.addEventListener('pointerdown', (ev) => {
      // If the pointerdown started on the close button, don't start dragging (avoid capture conflicts)
      if (ev.target && ev.target.closest && ev.target.closest('#closeSettings')) return;
      // Only start drag when the modal is visible
      if (!modal || modal.getAttribute('aria-hidden') === 'true') return;
      ev.preventDefault();
      settingsHeader.setPointerCapture(ev.pointerId);
      dragging = true;
      startX = ev.clientX;
      startY = ev.clientY;
      const rect = settingsContent.getBoundingClientRect();
      origLeft = rect.left;
      origTop = rect.top;
      // switch to fixed positioning so we can move freely
      settingsContent.style.position = 'fixed';
      settingsContent.style.left = `${origLeft}px`;
      settingsContent.style.top = `${origTop}px`;
      settingsContent.style.margin = '0';
    });

    window.addEventListener('pointermove', (ev) => {
      if (!dragging) return;
      ev.preventDefault();
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      let newLeft = origLeft + dx;
      let newTop = origTop + dy;
      // clamp inside viewport with 8px padding
      const maxLeft = Math.max(8, window.innerWidth - settingsContent.offsetWidth - 8);
      const maxTop = Math.max(8, window.innerHeight - settingsContent.offsetHeight - 8);
      newLeft = Math.min(Math.max(8, newLeft), maxLeft);
      newTop = Math.min(Math.max(8, newTop), maxTop);
      settingsContent.style.left = `${newLeft}px`;
      settingsContent.style.top = `${newTop}px`;
    });

    window.addEventListener('pointerup', (ev) => {
      if (!dragging) return;
      dragging = false;
      try { settingsHeader.releasePointerCapture(ev.pointerId); } catch(e){}
    });
  }

  // form submit (PUT/POST to server) - we assume endpoint exists
  document.getElementById('settingsForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
    try{
      const res = await fetch(API_PROFILE, { method: 'PUT', headers:{ 'Content-Type':'application/json'}, body: JSON.stringify(data) });
      if(!res.ok) throw new Error('save failed');
      showToast('Profile saved'); modal.style.display='none'; fetchProfile();
    }catch(err){ console.warn(err); showToast('Save failed'); }
  });

  document.getElementById('uploadBtn')?.addEventListener('click', uploadFile);
  document.getElementById('downloadResumeBtn')?.addEventListener('click', downloadResume);

  // delegate download buttons
  document.getElementById('fileList')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-id]'); if(!btn) return; const id = btn.dataset.id; downloadFile(id);
  });

  // initial load
  fetchProfile(); fetchFiles();
</script>

<output id="toast" class="toast" aria-live="polite"></output>
</body>
</html>

