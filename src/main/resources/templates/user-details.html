<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8" />
    <title>User Details - Nimbus</title>
    <link href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/user-details.css}" rel="stylesheet" />
</head>
<body>
<main class="ud-hero">
    <div class="ud-container" th:attr="data-profile-url=@{/api/v1/mvc/user/me}">
        <section class="ud-left">
            <h1>Nimbus</h1>
            <p class="tag">Your account</p>
            <p class="lead">Manage your profile and see your roles. Use the logout button to end your session.</p>
        </section>
        <aside class="ud-card">
            <h2>Your profile</h2>
            <div id="profile" class="profile-body">Loading...</div>
            <div class="card-actions">
                <a class="btn btn-primary" th:href="@{/api/v1/mvc/logout}">Logout</a>
            </div>
        </aside>
    </div>
</main>

<script>
    async function loadProfile() {
        const container = document.querySelector('.ud-container');
        if (!container) return;
        const profileUrl = container.getAttribute('data-profile-url');
        const el = document.getElementById('profile');
        el.innerText = 'Loading...';
        try {
            const resp = await fetch(profileUrl, { credentials: 'same-origin' });
            if (resp.status === 200) {
                const u = await resp.json();
                const roles = (u.userRoles || []).map(r => (r && r.role && r.role.name) ? r.role.name : null).filter(Boolean).join(', ');
                const html = `
                    <div class="row"><div class="label">First name</div><div class="value">${u.firstName || ''}</div></div>
                    <div class="row"><div class="label">Last name</div><div class="value">${u.lastName || ''}</div></div>
                    <div class="row"><div class="label">Username</div><div class="value">${u.username || ''}</div></div>
                    <div class="row"><div class="label">Email</div><div class="value">${u.email || ''}</div></div>
                    <div class="row"><div class="label">Active</div><div class="value"><span class="status ${u.isActive ? 'status-active' : 'status-inactive'}"><span class="dot"></span>${u.isActive ? 'Active' : 'Inactive'}</span></div></div>
                    <div class="row"><div class="label">Roles</div><div class="value">${roles}</div></div>
                `;
                el.innerHTML = html;
            } else if (resp.status === 401) {
                el.innerText = 'You are not authenticated. Please login.';
            } else {
                const text = await resp.text().catch(()=>null);
                el.innerText = 'Unable to load profile: ' + (text || resp.status);
            }
        } catch (e) {
            console.error('Failed to load profile', e);
            el.innerText = 'Unable to load profile: network error';
        }
    }
    loadProfile();
</script>
</body>
</html>
