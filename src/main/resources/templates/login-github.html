<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8" />
    <title>Login with GitHub - Nimbus</title>
    <link href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/login-github.css}" rel="stylesheet" />
</head>
<body>
<div class="lg-hero">
    <div class="lg-container">
        <div class="lg-left">
            <h1>Nimbus</h1>
            <p class="lead">Sign in with your GitHub account to continue to Nimbus — secure access with role-based controls.</p>
            <ul class="lg-features">
                <li>Fast GitHub authentication</li>
                <li>Simple registration flow</li>
                <li>Clear, accessible UI</li>
            </ul>
        </div>
        <div class="lg-card">
            <a class="btn btn-back" th:href="@{/api/v1/mvc/home}">&larr; Back</a>
            <h3>Login with GitHub</h3>
            <p class="muted">Enter the email you registered with and continue to GitHub to authorize.</p>

            <form id="loginForm" th:attr="data-validate-url=@{/api/v1/mvc/auth/validate-email}, data-authorize-url=@{/oauth2/authorization/github}">
                <label for="email">Email</label>
                <input id="email" name="email" type="email" required placeholder="you@domain.com" />
                <div class="actions">
                    <button class="btn btn-primary" type="submit">Login</button>
                    <a class="btn btn-outline" th:href="@{/api/v1/mvc/register}">Register</a>
                </div>
            </form>

            <div id="message" class="message" aria-live="polite"></div>
            <p class="small muted">We only use your email to match your account — you will be redirected to GitHub for authorization.</p>
        </div>
    </div>
</div>

<script>
    // Plain client-side JS — read URLs from the data attributes so Thymeleaf isn't used inside JS
    (function(){
        const formEl = document.getElementById('loginForm');
        if (!formEl) return;
        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const validateUrl = formEl.getAttribute('data-validate-url');
            const authorizeUrl = formEl.getAttribute('data-authorize-url');

            try {
                const resp = await fetch(validateUrl, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                if (!resp.ok) {
                    const text = await resp.text().catch(()=>null);
                    document.getElementById('message').innerText = 'Error validating email: ' + (text || resp.status);
                    return;
                }
                const result = await resp.json();
                if (result.exists) {
                    // proceed to OAuth2 authorization endpoint
                    window.location.href = authorizeUrl;
                } else {
                    document.getElementById('message').innerText = 'No registered user found with this email. Please register first.';
                }
            } catch (err) {
                console.error('Login validation failed', err);
                document.getElementById('message').innerText = 'Unable to validate email. Try again.';
            }
        });
    })();
</script>
</body>
</html>
